# KVM RPA 系统架构文档

## 1. 系统架构概览

### 1.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      KVM RPA 系统                            │
├─────────────────────────────────────────────────────────────┤
│                                                              │
│  ┌──────────────┐      ┌──────────────┐                     │
│  │  RTSP 视频源  │ ───> │ 视频采集模块  │                     │
│  │   (KVM设备)  │      │ RTSPCapture  │                     │
│  └──────────────┘      └──────┬───────┘                     │
│                               │                             │
│                               ↓                             │
│                       ┌───────────────┐                     │
│                       │ 图像预处理     │                     │
│                       │ ImageProcessor│                     │
│                       └───────┬───────┘                     │
│                               │                             │
│              ┌────────────────┴────────────────┐            │
│              ↓                                 ↓            │
│      ┌──────────────┐                 ┌──────────────┐     │
│      │ YOLO 检测    │                 │ OCR 识别      │     │
│      │YOLODetector  │                 │ OCREngine    │     │
│      └──────┬───────┘                 └──────┬───────┘     │
│             │                                │             │
│             └────────────┬───────────────────┘             │
│                          ↓                                 │
│                  ┌───────────────┐                         │
│                  │  规则引擎      │                         │
│                  │ RuleEngine    │                         │
│                  └───────┬───────┘                         │
│                          │                                 │
│                          ↓                                 │
│                  ┌───────────────┐                         │
│                  │ 键鼠适配器     │                         │
│                  │KeystrokeAdapter│                         │
│                  └───────┬───────┘                         │
│                          │                                 │
│                          ↓                                 │
│                  ┌───────────────┐                         │
│                  │ KVM 控制器 API │                         │
│                  │(第三方服务)    │                         │
│                  └───────────────┘                         │
│                                                            │
├─────────────────────────────────────────────────────────────┤
│                    API 服务层                               │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │  HTTP API    │  │  WebSocket   │  │ Prometheus   │     │
│  │  (FastAPI)   │  │   实时推送    │  │   监控指标    │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
```

### 1.2 数据流

```
RTSP 视频流 → 帧抓取 → 预处理 → YOLO/OCR 并行处理 
            → 规则评估 → 动作执行 → 键鼠指令发送
```

## 2. 核心模块设计

### 2.1 视频采集模块 (RTSPCapture)

**职责**：
- 从 RTSP 源拉取视频流
- 维护帧缓存队列
- 提供自动重连机制

**关键技术**：
- OpenCV VideoCapture
- 多线程采集（独立线程避免阻塞）
- 指数回退重连策略

**接口**：
```python
- start_stream() -> bool
- stop_stream() -> None
- get_frame(timeout) -> Optional[Dict]
- get_metrics() -> Dict
```

### 2.2 图像预处理模块 (ImageProcessor)

**职责**：
- 图像缩放、增强、去噪
- ROI 裁剪
- 为检测和识别优化图像

**可选处理**：
- 灰度化
- 直方图均衡化
- 自适应阈值二值化
- 锐化

### 2.3 YOLO 检测模块 (YOLODetector)

**职责**：
- UI 元素目标检测
- 返回边界框、类别、置信度
- 支持模型热更新

**技术实现**：
- 基于 Ultralytics YOLOv8
- 支持 CPU/GPU 推理
- NMS 后处理

**输出格式**：
```python
[{
    'label': 'button',
    'bbox': [x1, y1, x2, y2],
    'conf': 0.92,
    'center': [cx, cy],
    'class_id': 0
}]
```

### 2.4 OCR 识别模块 (OCREngine)

**职责**：
- 文字识别（中英文混合）
- 文本查找和匹配
- 置信度过滤

**技术实现**：
- 基于 PaddleOCR
- 支持方向分类
- 可配置语言列表

**输出格式**：
```python
[{
    'text': '下一步',
    'conf': 0.95,
    'bbox': [[x1,y1], [x2,y2], [x3,y3], [x4,y4]],
    'bbox_rect': [x, y, w, h]
}]
```

### 2.5 规则引擎 (RuleEngine)

**职责**：
- 规则匹配和触发
- 动作序列执行
- 支持简单的触发-动作模型

**规则格式**：
```python
{
    "name": "规则名称",
    "enabled": true,
    "trigger": {
        "type": "ocr",  # 或 "detection", "combined"
        "text_contains": "目标文本",
        "min_confidence": 0.7
    },
    "actions": [
        {"type": "click", "target": "trigger_bbox"},
        {"type": "wait", "duration": 1.0}
    ]
}
```

### 2.6 高级流程引擎

#### ScriptParser
- 解析 YAML 脚本
- 验证脚本格式
- 支持变量和触发器定义

#### Executor
- 执行脚本动作
- 支持条件分支、循环
- 变量替换 `${var_name}`

#### ExecutionContext
- 管理执行上下文
- 变量、计数器、标志
- 动作历史记录

### 2.7 键鼠适配层 (KeystrokeAdapter)

**职责**：
- 封装键鼠操作
- 通过 REST API 发送指令
- 重试机制

**支持的动作**：
- 鼠标移动、点击、拖拽
- 键盘输入、组合键
- 滚轮操作

**模拟模式**：
- 开发阶段使用模拟模式
- 生产环境替换为真实 KVM API

## 3. API 服务设计

### 3.1 HTTP API (FastAPI)

**端点分类**：
- **系统管理**：健康检查、统计信息
- **脚本管理**：加载、执行、查询状态
- **模型管理**：上传、热更新
- **配置管理**：读取、更新配置
- **日志查询**：查询系统日志

**标准响应格式**：
```json
{
    "request_id": "uuid",
    "status": "ok",
    "message": "操作成功",
    "data": {},
    "timestamp": "2025-11-19T12:00:00Z"
}
```

### 3.2 WebSocket 服务

**三个端点**：
1. `/ws/frame` - 实时画面流（JPEG 编码，Base64）
2. `/ws/inference` - 检测和识别结果（JSON）
3. `/ws/metrics` - 系统指标（JSON）

**连接管理**：
- 支持多客户端连接
- 自动清理断开的连接
- 按需推送（无客户端时不推送）

## 4. 监控与日志

### 4.1 日志系统 (Loguru)

**日志级别**：DEBUG, INFO, WARNING, ERROR, CRITICAL

**输出方式**：
- 控制台输出（彩色）
- 文件输出（按天轮转，保留 90 天）

**日志内容**：
- 每帧处理信息
- 检测/OCR 结果
- 动作执行记录
- 错误和异常堆栈

### 4.2 监控指标 (Prometheus)

**关键指标**：
- `rtsp_fps`：当前帧率
- `yolo_inference_duration_seconds`：YOLO 推理耗时
- `ocr_inference_duration_seconds`：OCR 识别耗时
- `kvm_api_calls_total`：键鼠 API 调用总数
- `pipeline_duration_seconds`：端到端处理耗时

**指标类型**：
- Counter：累计计数（帧数、调用次数）
- Gauge：瞬时值（帧率、延迟）
- Histogram：分布统计（耗时分布）

## 5. 性能优化策略

### 5.1 并行处理

- RTSP 采集在独立线程
- YOLO 和 OCR 可并行执行（如需）
- WebSocket 推送使用异步 IO

### 5.2 资源管理

- 帧缓存队列限制大小（避免内存溢出）
- 动作历史限制条数（最近 100 条）
- 日志自动轮转和压缩

### 5.3 优化建议

- 降低 FPS 到 5-8（非实时场景）
- 使用 GPU 加速（YOLO 和 OCR）
- ROI 裁剪减少计算量
- 调整模型大小（YOLOv8n vs YOLOv8x）

## 6. 容错与错误处理

### 6.1 RTSP 重连

- 指数回退策略
- 最多重试 3 次
- 记录重连事件

### 6.2 模型推理异常

- 捕获异常并记录
- 降级模式（仅 OCR 或仅 YOLO）
- 可选重启推理进程

### 6.3 键鼠 API 失败

- 最多重试 2 次
- 记录失败原因
- 触发告警（可选）

### 6.4 未识别情况

- 记录日志
- 回退到人工确认（可选）
- 根据配置决定是否继续

## 7. 扩展性设计

### 7.1 模块化

- 各模块独立封装
- 通过接口交互
- 便于单独测试和替换

### 7.2 配置驱动

- 所有参数外部配置
- 支持热加载
- 环境变量覆盖

### 7.3 多路处理

- 架构支持多路 RTSP 并行
- 需增加资源管理和调度

## 8. 安全考虑

### 8.1 通信安全

- 支持 HTTPS/WSS
- Token 认证
- 敏感配置加密存储

### 8.2 访问控制

- API 鉴权
- 最小权限原则
- 审计日志

### 8.3 数据隐私

- 不存储原始图像（可选）
- 敏感文本脱敏
- 符合合规要求

## 9. 部署架构

### 9.1 单机部署

```
┌─────────────────────────────────┐
│  Linux Server (Ubuntu 20.04+)  │
│  ├── Python 3.9+                │
│  ├── KVM RPA 系统                │
│  ├── Prometheus (可选)          │
│  └── Nginx (可选，反向代理)      │
└─────────────────────────────────┘
```

### 9.2 容器化部署（后续）

```
Docker Compose:
- kvm-rpa-backend
- kvm-rpa-frontend
- prometheus
- grafana
```

## 10. 技术栈总结

| 层次 | 技术 | 版本 |
|------|------|------|
| 语言 | Python | 3.9+ |
| 视频处理 | OpenCV | 4.8+ |
| 目标检测 | Ultralytics YOLOv8 | 8.0+ |
| OCR | PaddleOCR | 2.7+ |
| Web 框架 | FastAPI | 0.104+ |
| 日志 | Loguru | 0.7+ |
| 监控 | Prometheus Client | 0.19+ |
| 配置 | PyYAML | 6.0+ |
| HTTP 客户端 | Requests | 2.31+ |

---

**文档版本**：1.0  
**最后更新**：2025-11-19

