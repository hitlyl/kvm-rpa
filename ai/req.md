# KVM RPA — 需求分析文档

**版本**：1.0
**日期**：2025-11-19
**作者**：产品/方案团队

---

## 1. 项目概述

本项目目标是构建一个基于 KVM 视频画面抓取的 RPA（代操作）系统。系统通过从 KVM/采集设备获取 RTSP 视频流（或 USB 采集卡），使用 OpenCV 抓图，结合 YOLO 进行界面/控件检测和 OCR 识别文字，再通过第三方 API 发起键盘鼠标操作请求来实现对被控机器的自动化操作。

**关键技术栈**：Python、OpenCV、YOLO（目标检测）、OCR（PaddleOCR/其他）、第三方键鼠注入 API（REST/gRPC）。

## 2. 项目目标与成功标准

### 2.1 目标

- 能稳定从 RTSP 流实时抓取屏幕帧（支持 720p 或 1080p）。
- 使用 YOLO 检测界面元素（按钮、输入框、弹窗等），并返回坐标与置信度。
- 使用 OCR 识别界面上的中文/英文文本并进行语义匹配。
- 将识别结果按照预定义策略映射为键盘/鼠标指令，通过第三方 API 发送到 KVM 设备或控制器。
- 提供日志、告警与可观测性（帧率、识别延迟、失败率）。

### 2.2 成功标准（验收）

- 在网络稳定、分辨率 1280x720 情况下，端到端平均响应时延（抓图 → 检测 →OCR→ 指令下达）< 1.2s。
- YOLO 对关键 UI 元素的召回率 ≥ 95%、精确率 ≥ 92%（在测试集上）。
- OCR 对关键文本识别准确率 ≥ 94%（常见中文/数字/英文字段）。
- 系统连续运行 72 小时无关键故障（内存泄漏/崩溃）。

## 3. 范围 & 约束

### 3.1 功能范围

- 支持 RTSP 视频源（主）和本地 USB 采集卡（辅）。
- 支持 YOLO 模型部署（可换模型权重）。
- 支持 PaddleOCR（或替代 OCR 引擎）。
- 支持通过 REST/gRPC 的第三方键鼠 API（发送鼠标移动、点击、键入、组合键等）。
- 支持脚本化的 RPA 流程编排（基于识别事件触发操作）。

### 3.2 非功能性约束

- 部署环境为 Linux（Ubuntu 20.04/22.04）。
- Python 版本：3.9+。
- 推理优先使用 CPU 或带 CUDA 的 GPU（可选）。
- 不直接在被控主机上执行任何代码（所有操作通过键鼠注入）。

## 4. 关键参与者（Stakeholders）

- 产品经理：需求定义与验收。
- 开发工程师（Python、AI、后端）：实现与集成。
- 算法工程师：训练/校准 YOLO、OCR 模型。
- 运维工程师：部署、监控与告警。
- 测试工程师：性能/稳定性/准确性测试。
- 第三方 API 提供方：键鼠注入服务接口。

## 5. 功能需求（详细）

### 5.1 视频采集模块

- 能从 RTSP 地址拉流并维持重连策略（指数回退/有限重试）。
- 支持拉取分辨率设置（720p/1080p）与帧率选择（默认 5-15 fps）。
- 提供帧缓存队列（大小可配置，默认 3 帧）。
- 提供抓图 API：`get_frame()` 返回 BGR numpy 数组与时间戳。
- 监控项：当前帧率、丢帧次数、拉流延迟。

### 5.2 预处理模块

- 支持图像缩放、灰度/增强（可选）、ROI 裁剪（针对固定布局可提高性能）。
- 支持图像去噪与对比度调整（可参数化）。

### 5.3 YOLO 检测模块

- 输入：BGR 图像或预处理图像。
- 输出：检测框列表（类别、左上/右下坐标、置信度、中心点）。
- 支持模型热更新（无缝替换权重）。
- 支持最小置信度阈值、NMS 过滤参数配置。
- 提供指标：每帧检测时间、平均推理时间、检测计数。

### 5.4 OCR 模块

- 能在给定 ROI 或整帧上运行 OCR 并返回：识别文本、置信度、文本边界框。
- 支持中文简体与英文混合识别。
- 可配置：最小文本置信度、文本后处理（正则、字典修正）。

### 5.5 规则引擎 / 流程编排

- 支持声明式的规则或小型脚本语言，能够定义：

  - 触发条件（检测到指定控件/文本、文本匹配正则、超时）。
  - 动作序列（点击坐标、发送按键、等待、条件分支）。

- 支持条件判断（如文本包含/等于、坐标存在或不存在、计数器）。
- 提供回放/回滚机制与操作审计（记录时间戳、触发原因、执行结果）。

### 5.6 键鼠 API 适配层

- 将高层动作转译为第三方 API 调用（REST/gRPC）。
- 支持动作：鼠标移动（绝对/相对）、鼠标点击（左/右/双击）、鼠标拖拽、键入文本、按键组合、按键按下/释放。
- 支持调用重试与幂等性保证（避免重复执行导致异常）。
- 配置参数：目标 API 地址、鉴权信息（Token/证书）、超时设置。

### 5.7 日志与监控

- 详细日志：每帧抓取日志、检测与 OCR 结果、动作下发日志（含请求与响应）。
- 指标输出：帧率、平均处理时延、API 调用延迟/失败率、模型推理时间。
- 告警策略：关键错误（长时间无法拉流、模型崩溃、API 连续失败）触发邮件/钉钉/Prometheus Alert。

### 5.8 管理与配置

- 提供 YAML/JSON 配置文件支持：RTSP 地址、模型路径、阈值、API 配置、流程脚本路径。
- 配置热加载（修改配置后可选择热重启模块或即时生效）。

## 6. 非功能需求

### 6.1 性能

- 单实例支持 5–15 FPS（取决于模型和硬件）。
- 单帧处理（检测+OCR）平均耗时 ≤ 800ms（目标）。

### 6.2 可用性

- 系统可用率 ≥ 99.5%。
- 支持主进程守护与自动重启。

### 6.3 扩展性

- 支持多路 RTSP 源并行处理（伸缩性依赖硬件）。
- 模块化设计：采集、推理、调度、API 适配分离。

### 6.4 安全

- 通过 HTTPS 与键鼠 API 通讯或使用 mTLS（根据第三方支持）。
- 对敏感配置（Token、密钥）做加密存储或使用 Secrets 管理。
- 最低权限原则，不在被控机上运行任何代理服务。

## 7. 接口设计（概要）

### 7.1 视频采集模块

- `start_stream(rtsp_url, options) -> stream_id`
- `stop_stream(stream_id)`
- `get_frame(stream_id) -> {'frame': np.ndarray, 'ts': float}`

### 7.2 推理模块

- `detect(frame) -> [{'label':str, 'bbox':[x1,y1,x2,y2], 'conf':float}]`
- `ocr(frame_or_roi) -> [{'text':str, 'conf':float, 'bbox':[x1,y1,x2,y2]}]`

### 7.3 流程引擎

- `execute_script(script_id, context) -> {'status':'ok'|'error', 'logs':[]}`
- `register_trigger(trigger_rule)`

### 7.4 键鼠 API 适配层

- `send_mouse_move(x, y, mode='absolute')`
- `send_mouse_click(button='left', clicks=1)`
- `send_key_input('Hello')`
- `send_key_combination(['CTRL','ALT','DEL'])`

> 所有对外 HTTP 接口均返回标准化的 JSON，包含 `request_id`、`status`、`message`、`timestamp`。

## 8. 数据与存储

- 操作审计日志保留 90 天（可配置），并按天轮转。
- 模型与配置文件存储在本地文件系统或网络存储（NFS）。
- 识别结果（若需训练改进）可采集并匿名化后上传到模型训练仓库（受隐私与合规控制）。

## 9. 容错策略与异常处理

- 拉流失败：立即重试 3 次，随后按指数回退；重连成功后记录事件并告警。
- 模型推理异常：重启推理进程并切换到备份模型或降级模式（仅 OCR 或仅 YOLO）。
- 键鼠 API 调用失败：重试 2 次，若失败记录并触发人工干预流程。
- 遇到未识别或多个匹配控件：按规则取最高置信度或回退至人工确认。

## 10. 部署方案

- 使用 Systemd 管理服务或容器化（Docker + docker-compose / Kubernetes）。
- 生产建议配置：

  - CPU 服务器：8 核以上 + 32GB RAM；若用 GPU：NVIDIA T4 或 V100。
  - 存储：50GB 起（日志、模型、容器镜像）。

- 网络：保证 RTSP 源到处理机的带宽与稳定性（建议 50Mbps 以上并低丢包）。

## 11. 测试计划

- **功能测试**：单个流程从抓图到动作下发的正确性测试。
- **性能测试**：压力测试多路 RTSP 并行、模型推理吞吐。
- **稳定性测试**：连续运行 72 小时、内存/CPU/帧率监控。
- **回归测试**：模型更新后对比关键指标（召回率、精确率、OCR 准确率）。

## 12. 验收标准（复述）

- YOLO 与 OCR 精度满足 5.2 节阐述的阈值。
- 端到端响应时延满足 2.2 节目标。
- 系统能在目标硬件上稳定运行 72 小时无关键故障。

## 13. 里程碑与交付物

- M1（2 周）：原型 — RTSP 拉流 + 单帧抓取 + 日志。
- M2（4 周）：YOLO 检测集成 + 简单规则驱动动作下发（可用第三方 API 测试）。
- M3（6 周）：OCR 集成 + 完整流程脚本支持 + 审计日志。
- M4（8 周）：稳定性、性能优化 + 部署脚本 + 文档与验收。

## 14. 风险与缓解措施

- **网络波动导致抓图失败**：使用本地缓存、重试策略与带宽监控。
- **模型识别误判**：增加人工确认回退路径、持续收集错识样本做再训练。
- **第三方 API 不稳定**：缓存关键操作、增加超时与备用 API 提供方。
- **隐私/合规问题**：对识别到的敏感信息做脱敏或不存储原始图像。

## 16. 前端界面需求（Vue3）

### 16.1 前端整体目标

前端为 RPA 管理端，主要负责：实时画面展示、检测框与 OCR 可视化、脚本编辑、模型与配置管理、系统监控等，并与后端 Python API 通信。

### 16.2 前端功能需求

- **实时画面展示**：支持截图流展示、YOLO 框与 OCR 文本叠加、缩放与暂停。
- **流程编排界面**：支持可视化拖拽节点编辑器（动作节点、条件节点、识别节点），支持 YAML/JSON 编辑与脚本测试。
- **系统监控界面**：展示帧率、推理耗时、API 调用延迟、RTSP 状态等（通过 WebSocket 获取实时数据）。
- **模型管理界面**：模型上传、热更新、版本信息展示。
- **配置管理界面**：编辑系统配置（RTSP、模型、OCR、API）并支持版本记录。
- **日志中心**：操作日志、识别日志与系统日志展示与筛选。

### 16.3 技术栈

Vue3、Vite、Element Plus/Naive UI、Pinia、Vue Router、Axios、WebSocket、Monaco Editor、ECharts。

### 16.4 模块结构

```
src/
  api/          # API 封装
  pages/        # 页面模块（监控、画面、脚本、模型、配置、日志）
  components/   # 通用组件
  store/        # Pinia
  utils/
```

### 16.5 前后端交互

- `/ws/frame`：实时画面流
- `/ws/inference`：YOLO 与 OCR 结果
- `/ws/metrics`：性能指标
- `/api/scripts/*`：脚本管理
- `/api/model/*`：模型上传、热更新
- `/api/config/*`：系统配置管理

### 16.6 非功能性要求

页面加载 < 2 秒；支持 1080p 显示；实时数据 ≥ 1 FPS；兼容 Chrome 110+

---

## 15. 附录

### 15.1 配置示例（YAML）

```yaml
rtsp:
  url: "rtsp://10.0.0.10:554/stream"
  fps: 8
  resolution: [1280, 720]
models:
  yolo:
    path: "/opt/models/yolo_best.pt"
    conf_threshold: 0.25
  ocr:
    engine: "paddle"
api:
  keystroke:
    url: "https://kbd-api.internal/v1/exec"
    token: "xxxx"
```

### 15.2 流程脚本示例（伪）

```
trigger:
  - when: ocr.text contains "下一步"
    do:
      - click: element=button_next
      - wait: 1.0
      - ocr_check: region=top_right text contains "安装完成"
```

---

如需，我可以在文档基础上继续输出：

- 详细的接口规范（每个 API 的 request/response JSON 示例）；
- Python 代码骨架（rtsp 拉流、YOLO 推理、OCR 调用、键鼠 API 适配器）；
- 测试用例与数据集标注规范。
